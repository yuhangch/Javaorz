# Java虚拟机

## Q1:JVM内存（区域）模型

JVM内存区域分为线程私有区域和线程共享区域，及直接内存。

线程私有区域的生命周期与线程相同，由于JVM线程与操作系统本地线程直接映射，因此这部分也与本地线程启动销毁对应。

- 程序计数器（用于存储当前线程执行字节码的行号指示器）
- 虚拟机栈（描述Java方法执行过程）
  栈帧用来记录方法的执行过程，在方法被执行时虚拟机为其创建栈帧，方法的执行和返回对应栈帧的入栈和出栈。
  当前栈帧中储存了【局部变量表、操作数栈、动态链接和方法出口】，还用来存储部分运行时数据及其数据结构，处理动态链接方法的返回值和异常分派。
- 本地方法区（描述Native方法执行过程）

线程共享区随虚拟机的启动而创建，随虚拟机的关闭而销毁。

直接内存（堆外内存），不属于JVM运行时数据区部分。JDK NIO模块通过Native函数库在操作系统上分配堆外内存，可避免数据在Java堆和Native堆中来回复制带来的资源消耗。

- 堆
  JVM运行过程中创建的对象和产生的数据存放在堆中，是垃圾回收器作用的最主要的内存区域。

- 方法区

  也被称为永久代，用于存储常量、静态变量、类信息、即时编译后的机器码、运行时常量池。

Q2:对象的创建

前三个步骤由虚拟机执行

1. 分配空间

   内存绝对规整：指针碰撞（Bump the Pointer）【使用Serial、ParNew等压缩整理算法时】

   内存相互交错：虚拟机维护一个空闲列表【使用CMS这种基于；清除算法的收集器】

   为保证线程安全

   一是采用CAS配上失败重试的方式来保证更新操作的原子性

   另一种是在Java堆中预先分配一小块内存成为本地线程分配缓冲（Thread Local Allocation Buffer，TLAB）

2. 内存空间初始化

   将分配到的内存空间初始化为零值

   使用TLAB的话，这一步可在TLAB分配时顺便进行

3. 设置对象

   对象头：对象是哪个类的实例，如何找到累的元数据信息、对象的GC分代年龄等信息。

从java程序角度来看，还有以下步骤

new之后跟着使用class的<init>()方法，对象才算被完全构造出来。

